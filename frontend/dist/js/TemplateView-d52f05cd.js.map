{"version":3,"file":"TemplateView-d52f05cd.js","sources":["../../src/views/TemplateView.vue"],"sourcesContent":["<script setup>\nimport { ref, inject, onMounted } from 'vue'\nimport { useRoute, useRouter, onBeforeRouteLeave } from 'vue-router'\nimport { useI18n } from 'vue-i18n'\n\nimport General from '@/components/template/General.vue'\nimport Variables from '@/components/template/Variables.vue'\nimport Install from '@/components/template/Install.vue'\nimport Hooks from '@/components/template/Hooks.vue'\nimport RunConfig from '@/components/template/RunConfig.vue'\nimport Environment from '@/components/template/Environment.vue'\n\nimport Ace from '@/components/ui/Ace.vue'\nimport Btn from '@/components/ui/Btn.vue'\nimport Icon from '@/components/ui/Icon.vue'\nimport Loader from '@/components/ui/Loader.vue'\nimport Tabs from '@/components/ui/Tabs.vue'\nimport Tab from '@/components/ui/Tab.vue'\n\nconst api = inject('api')\nconst toast = inject('toast')\nconst events = inject('events')\nconst { t } = useI18n()\nconst route = useRoute()\nconst router = useRouter()\n\nlet unmodified = null\nconst template = ref(null)\nconst valid = ref({\n  general: true,\n  run: true\n})\nconst ace = ref(null)\n\nonBeforeRouteLeave(() => {\n  if (unmodified === template.value) {\n    return true\n  } else {\n    return new Promise((resolve) => {\n      events.emit(\n        'confirm',\n        t('common.ConfirmLeave'),\n        {\n          text: t('common.Discard'),\n          icon: 'remove',\n          color: 'error',\n          action: () => { resolve(true) }\n        },\n        {\n          color: 'primary',\n          action: () => { resolve(false) }\n        }\n      )\n    })\n  }\n})\n\nonMounted(async () => {\n  const res = await api.template.get(route.params.repo, route.params.id)\n  delete res.readme\n  if (!res.environment) res.environment = {}\n  if (!res.supportedEnvironments) res.supportedEnvironments = []\n  template.value = JSON.stringify(res, undefined, 4)\n  setTimeout(() => {\n    unmodified = template.value\n  }, 50)\n})\n\nasync function deleteTemplate() {\n  if (!canDelete()) return\n  events.emit(\n    'confirm',\n    t('templates.ConfirmDelete', { name: JSON.parse(template.value).display }),\n    {\n      text: t('templates.Delete'),\n      icon: 'remove',\n      color: 'error',\n      action: async () => {\n        await api.template.delete(route.params.id)\n        toast.success(t('templates.Deleted'))\n        router.push({ name: 'TemplateList' })\n      }\n    },\n    {\n      color: 'primary'\n    }\n  )\n}\n\nfunction canDelete() {\n  return route.params.repo === '0'\n}\n\nasync function save() {\n  if (!canSave()) return\n  const data = template.value\n  await api.template.save(route.params.id, data)\n  // update the clean state to prevent confirmation popup\n  // on leave despite no unsaved changes existing\n  unmodified = data\n  toast.success(t('templates.Saved'))\n}\n\nfunction canSave() {\n  if (route.params.repo !== '0') return false\n  return Object.values(valid.value).filter(e => e === false).length === 0\n}\n\nfunction createLocalCopy() {\n  const t = JSON.parse(template.value)\n  delete t.name\n  sessionStorage.setItem('copiedTemplate', JSON.stringify(t))\n  router.push({ name: 'TemplateCreate', query: { 'copy': true } })\n}\n\nfunction tabChanged(newTab) {\n  if (newTab === 'json' && ace.value) ace.value.refresh()\n}\n</script>\n\n<template>\n  <div class=\"templateview\">\n    <loader v-if=\"!template\" />\n    <div v-else>\n      <div v-if=\"route.params.repo !== '0'\" class=\"alert info\">\n        <span v-text=\"t('templates.EditLocalOnly')\" />\n        <btn color=\"primary\" @click=\"createLocalCopy()\"><icon name=\"copy\" />{{ t('templates.CreateLocalCopy') }}</btn>\n      </div>\n      <tabs anchors @tabChanged=\"tabChanged\">\n        <tab id=\"general\" :title=\"t('templates.General')\" icon=\"general\" hotkey=\"t g\">\n          <general v-model=\"template\" @valid=\"valid.general = $event\" />\n        </tab>\n        <tab id=\"variables\" :title=\"t('templates.Variables')\" icon=\"variables\" hotkey=\"t v\">\n          <variables v-model=\"template\" />\n        </tab>\n        <tab id=\"install\" :title=\"t('templates.Install')\" icon=\"install\" hotkey=\"t i\">\n          <install v-model=\"template\" />\n        </tab>\n        <tab id=\"run\" :title=\"t('templates.RunConfig')\" icon=\"start\" hotkey=\"t r\">\n          <run-config v-model=\"template\" @valid=\"valid.run = $event\" />\n        </tab>\n        <tab id=\"hooks\" :title=\"t('templates.Hooks')\" icon=\"hooks\" hotkey=\"t h\">\n          <hooks v-model=\"template\" />\n        </tab>\n        <tab id=\"environment\" :title=\"t('templates.Environment')\" icon=\"environment\" hotkey=\"t e\">\n          <environment v-model=\"template\" />\n        </tab>\n        <tab id=\"json\" :title=\"t('templates.Json')\" icon=\"json\" hotkey=\"t j\">\n          <Ace id=\"template-json\" ref=\"ace\" v-model=\"template\" class=\"template-json-editor\" mode=\"json\" />\n        </tab>\n      </tabs>\n      <div v-if=\"route.params.repo === '0'\" class=\"actions\">\n        <btn color=\"error\" :disabled=\"!canDelete()\" @click=\"deleteTemplate()\"><icon name=\"remove\" />{{ t('templates.Delete') }}</btn>\n        <btn color=\"primary\" :disabled=\"!canSave()\" @click=\"save()\"><icon name=\"save\" />{{ t('templates.Save') }}</btn>\n      </div>\n    </div>\n  </div>\n</template>\n"],"names":[],"mappings":"mpBAmBA,KAAM,GAAM,EAAO,OACb,EAAQ,EAAO,SACf,EAAS,EAAO,UAChB,CAAE,KAAM,IACR,EAAQ,IACR,EAAS,IAEf,GAAI,GAAa,KACjB,KAAM,GAAW,EAAI,MACf,EAAQ,EAAI,CAChB,QAAS,GACT,IAAK,KAED,EAAM,EAAI,MAEhB,EAAmB,IACb,IAAe,EAAS,MACnB,GAEA,GAAI,SAAQ,AAAC,GAAY,CAC9B,EAAO,KACL,UACA,EAAE,uBACF,CACE,KAAM,EAAE,kBACR,KAAM,SACN,MAAO,QACP,OAAQ,IAAM,CAAE,EAAQ,MAE1B,CACE,MAAO,UACP,OAAQ,IAAM,CAAE,EAAQ,UAOlC,EAAU,SAAY,CACpB,KAAM,GAAM,KAAM,GAAI,SAAS,IAAI,EAAM,OAAO,KAAM,EAAM,OAAO,IACnE,MAAO,GAAI,OACN,EAAI,aAAa,GAAI,YAAc,IACnC,EAAI,uBAAuB,GAAI,sBAAwB,IAC5D,EAAS,MAAQ,KAAK,UAAU,EAAK,OAAW,GAChD,WAAW,IAAM,CACf,EAAa,EAAS,OACrB,MAGL,kBAAgC,CAC9B,AAAI,CAAC,KACL,EAAO,KACL,UACA,EAAE,0BAA2B,CAAE,KAAM,KAAK,MAAM,EAAS,OAAO,UAChE,CACE,KAAM,EAAE,oBACR,KAAM,SACN,MAAO,QACP,OAAQ,SAAY,CAClB,KAAM,GAAI,SAAS,OAAO,EAAM,OAAO,IACvC,EAAM,QAAQ,EAAE,sBAChB,EAAO,KAAK,CAAE,KAAM,mBAGxB,CACE,MAAO,YAKb,YAAqB,CACnB,MAAO,GAAM,OAAO,OAAS,IAG/B,kBAAsB,CACpB,GAAI,CAAC,IAAW,OAChB,KAAM,GAAO,EAAS,MACtB,KAAM,GAAI,SAAS,KAAK,EAAM,OAAO,GAAI,GAGzC,EAAa,EACb,EAAM,QAAQ,EAAE,oBAGlB,YAAmB,CACjB,MAAI,GAAM,OAAO,OAAS,IAAY,GAC/B,OAAO,OAAO,EAAM,OAAO,OAAO,GAAK,IAAM,IAAO,SAAW,EAGxE,YAA2B,CACzB,KAAM,GAAI,KAAK,MAAM,EAAS,OAC9B,MAAO,GAAE,KACT,eAAe,QAAQ,iBAAkB,KAAK,UAAU,IACxD,EAAO,KAAK,CAAE,KAAM,iBAAkB,MAAO,CAAE,KAAQ,MAGzD,WAAoB,EAAQ,CAC1B,AAAI,IAAW,QAAU,EAAI,OAAO,EAAI,MAAM"}