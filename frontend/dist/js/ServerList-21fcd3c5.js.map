{"version":3,"file":"ServerList-21fcd3c5.js","sources":["../../src/views/ServerList.vue"],"sourcesContent":["<script setup>\nimport { ref, inject, onMounted, onUnmounted, nextTick } from 'vue'\nimport { RouterLink } from 'vue-router'\nimport { useI18n } from 'vue-i18n'\nimport Icon from '@/components/ui/Icon.vue'\nimport Loader from '@/components/ui/Loader.vue'\n\nconst api = inject('api')\nconst { t } = useI18n()\n\nconst servers = ref([])\nlet lastPage = 0\nlet loadingPage = false\nconst allServersLoaded = ref(false)\nconst loaderRef = ref(null)\nconst firstEntry = ref(null)\nlet interval = null\n\nfunction addServers(newServers) {\n  newServers.map(server => servers.value.push(server))\n  refreshServerStatus()\n}\n\nasync function refreshServerStatus() {\n  servers.value.map(async s => {\n    if (s.canGetStatus) {\n      s.online = 'loading'\n      try {\n        s.online = await api.server.getStatus(s.id)\n      } catch {\n        s.online = undefined\n      }\n    }\n  })\n}\n\nfunction isLoaderVisible() {\n  if (!loaderRef.value) return false\n  const vw = window.innerWidth || document.documentElement.clientWidth\n  const vh = window.innerHeight || document.documentElement.clientHeight\n  const rect = loaderRef.value.$el.getBoundingClientRect()\n  return rect.top >= 0 && rect.left >= 0 && rect.bottom <= vh && rect.right <= vw\n}\n\nasync function loadPage(page = 1) {\n  loadingPage = true\n  const data = await api.server.list(page)\n  addServers(data.servers)\n  lastPage = data.paging.page\n  allServersLoaded.value = data.paging.page * data.paging.pageSize >= (data.paging.total || 0)\n  nextTick(() => {\n    loadingPage = false\n    if (!allServersLoaded.value && isLoaderVisible()) loadPage(lastPage + 1)\n  })\n}\n\nfunction onScroll() {\n  if (!loadingPage && isLoaderVisible()) loadPage(lastPage + 1)\n}\n\nonMounted(() => {\n  interval = setInterval(refreshServerStatus, 30 * 1000)\n  nextTick(() => {\n    loadPage()\n    window.addEventListener('scroll', onScroll)\n  })\n})\n\nonUnmounted(() => {\n  clearInterval(interval)\n  window.removeEventListener('scroll', onScroll)\n})\n\nfunction getServerAddress(server) {\n  let ip = server.node.publicHost\n  if (server.ip && server.ip !== '0.0.0.0') {\n    ip = server.ip\n  }\n  return ip + (server.port ? ':' + server.port : '')\n}\n\nfunction setFirstEntry(ref) {\n  if (!firstEntry.value) firstEntry.value = ref\n}\n\nfunction focusList() {\n  firstEntry.value.$el.focus()\n}\n</script>\n\n<template>\n  <div class=\"serverlist\">\n    <h1 v-text=\"t('servers.Servers')\" />\n    <div v-hotkey=\"'l'\" class=\"list\" @hotkey=\"focusList()\">\n      <div v-for=\"server in servers\" :key=\"server.id\" class=\"list-item\">\n        <router-link :ref=\"setFirstEntry\" :to=\"{ name: 'ServerView', params: { id: server.id } }\">\n          <div\n            :class=\"['server', `server-${(server.icon || 'none')}`]\"\n            :data-online=\"server.online\"\n          >\n            <span class=\"title\" :title=\"server.name\">{{server.name}}</span>\n            <span class=\"type\">{{server.type}}</span>\n            <span class=\"subline\">{{getServerAddress(server)}} @ {{server.node.name}}</span>\n          </div>\n        </router-link>\n      </div>\n      <div v-if=\"!allServersLoaded\" class=\"list-item\">\n        <loader ref=\"loaderRef\" small />\n      </div>\n      <div v-if=\"$api.auth.hasScope('server.create')\" class=\"list-item\">\n        <router-link v-hotkey=\"'c'\" :to=\"{ name: 'ServerCreate' }\">\n          <div class=\"createLink\"><icon name=\"plus\" />{{ t('servers.Add') }}</div>\n        </router-link>\n      </div>\n    </div>\n  </div>\n</template>\n"],"names":[],"mappings":"yaAOA,KAAM,GAAM,EAAO,OACb,CAAE,KAAM,IAER,EAAU,EAAI,IACpB,GAAI,GAAW,EACX,EAAc,GAClB,KAAM,GAAmB,EAAI,IACvB,EAAY,EAAI,MAChB,EAAa,EAAI,MACvB,GAAI,GAAW,KAEf,WAAoB,EAAY,CAC9B,EAAW,IAAI,GAAU,EAAQ,MAAM,KAAK,IAC5C,IAGF,kBAAqC,CACnC,EAAQ,MAAM,IAAI,KAAM,IAAK,CAC3B,GAAI,EAAE,aAAc,CAClB,EAAE,OAAS,UACX,GAAI,CACF,EAAE,OAAS,KAAM,GAAI,OAAO,UAAU,EAAE,SACxC,CACA,EAAE,OAAS,WAMnB,YAA2B,CACzB,GAAI,CAAC,EAAU,MAAO,MAAO,GAC7B,KAAM,GAAK,OAAO,YAAc,SAAS,gBAAgB,YACnD,EAAK,OAAO,aAAe,SAAS,gBAAgB,aACpD,EAAO,EAAU,MAAM,IAAI,wBACjC,MAAO,GAAK,KAAO,GAAK,EAAK,MAAQ,GAAK,EAAK,QAAU,GAAM,EAAK,OAAS,EAG/E,iBAAwB,EAAO,EAAG,CAChC,EAAc,GACd,KAAM,GAAO,KAAM,GAAI,OAAO,KAAK,GACnC,EAAW,EAAK,SAChB,EAAW,EAAK,OAAO,KACvB,EAAiB,MAAQ,EAAK,OAAO,KAAO,EAAK,OAAO,UAAa,GAAK,OAAO,OAAS,GAC1F,EAAS,IAAM,CACb,EAAc,GACV,CAAC,EAAiB,OAAS,KAAmB,EAAS,EAAW,KAI1E,YAAoB,CAClB,AAAI,CAAC,GAAe,KAAmB,EAAS,EAAW,GAG7D,EAAU,IAAM,CACd,EAAW,YAAY,EAAqB,GAAK,KACjD,EAAS,IAAM,CACb,IACA,OAAO,iBAAiB,SAAU,OAItC,EAAY,IAAM,CAChB,cAAc,GACd,OAAO,oBAAoB,SAAU,KAGvC,WAA0B,EAAQ,CAChC,GAAI,GAAK,EAAO,KAAK,WACrB,MAAI,GAAO,IAAM,EAAO,KAAO,WAC7B,GAAK,EAAO,IAEP,EAAM,GAAO,KAAO,IAAM,EAAO,KAAO,IAGjD,WAAuB,EAAK,CAC1B,AAAK,EAAW,OAAO,GAAW,MAAQ,GAG5C,YAAqB,CACnB,EAAW,MAAM,IAAI"}