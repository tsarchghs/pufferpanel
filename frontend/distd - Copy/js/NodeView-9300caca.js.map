{"version":3,"file":"NodeView-9300caca.js","sources":["../../src/views/NodeView.vue"],"sourcesContent":["<script setup>\nimport { ref, inject, onMounted } from 'vue'\nimport { useRoute, useRouter } from 'vue-router'\nimport { useI18n } from 'vue-i18n'\nimport markdown from '@/utils/markdown'\nimport Btn from '@/components/ui/Btn.vue'\nimport Icon from '@/components/ui/Icon.vue'\nimport Loader from '@/components/ui/Loader.vue'\nimport Overlay from '@/components/ui/Overlay.vue'\nimport TextField from '@/components/ui/TextField.vue'\nimport Toggle from '@/components/ui/Toggle.vue'\n\nconst api = inject('api')\nconst toast = inject('toast')\nconst events = inject('events')\nconst { t } = useI18n()\nconst route = useRoute()\nconst router = useRouter()\n\nconst deploymentOpen = ref(false)\nlet deploymentData = {}\nconst withPrivateHost = ref(false)\nconst name = ref('')\nconst publicHost = ref('')\nconst publicPort = ref('8080')\nconst privateHost = ref('')\nconst privatePort = ref('8080')\nconst sftpPort = ref('5657')\nconst currentStep = ref(1)\nconst featuresFetched = ref(null)\nconst features = ref({})\n\nonMounted(async () => {\n  const node = await api.node.get(route.params.id)\n  name.value = node.name\n  publicHost.value = node.publicHost\n  publicPort.value = node.publicPort\n  privateHost.value = node.privateHost\n  privatePort.value = node.privatePort\n  sftpPort.value = node.sftpPort\n  withPrivateHost.value = !(node.publicHost === node.privateHost && node.publicPort === node.privatePort)\n  deploymentData = await api.node.deployment(route.params.id)\n  if (route.query.created) {\n    deploymentOpen.value = true\n  }\n\n  fetchFeatures()\n})\n\nasync function fetchFeatures() {\n  featuresFetched.value = null\n  features.value = {}\n  try {\n    const f = await api.node.features(route.params.id)\n    features.value.envs = [ ...new Set(f.environments.map(e => e === 'standard' || e === 'tty' ? 'host' : e)) ].map(e => t(`env.${e}.name`))\n    features.value.docker = f.features.indexOf('docker') !== -1\n    features.value.os = f.os\n    features.value.arch = f.arch\n    featuresFetched.value = true\n  } catch(e) {\n    featuresFetched.value = false\n  }\n}\n\nfunction canSubmit() {\n  if (!name.value) return false\n  if (!publicHost.value) return false\n  if (!publicPort.value) return false\n  if (!sftpPort.value) return false\n  if (withPrivateHost.value) {\n    if (!privateHost.value) return false\n    if (!privatePort.value) return false\n  }\n  return true\n}\n\nasync function submit() {\n  if (!canSubmit()) return\n  const node = {\n    name: name.value,\n    publicHost: publicHost.value,\n    publicPort: publicPort.value,\n    sftpPort: sftpPort.value\n  }\n  if (withPrivateHost.value) {\n    node.privateHost = privateHost.value\n    node.privatePort = privatePort.value\n  } else {\n    node.privateHost = publicHost.value\n    node.privatePort = publicPort.value\n  }\n  await api.node.update(route.params.id, node)\n  toast.success(t('nodes.Updated'))\n}\n\nasync function deleteNode() {\n  events.emit(\n    'confirm',\n    t('nodes.ConfirmDelete', { name: name.value }),\n    {\n      text: t('nodes.Delete'),\n      icon: 'remove',\n      color: 'error',\n      action: async () => {\n        await api.node.delete(route.params.id)\n        toast.success(t('nodes.Deleted'))\n        router.push({ name: 'NodeList' })\n      }\n    },\n    {\n      color: 'primary'\n    }\n  )\n}\n\nfunction getDeployConfig() {\n  const config = {\n    logs: '/var/log/pufferpanel',\n    web: {\n      host: `0.0.0.0:${privatePort.value}`\n    },\n    token: {\n      public: location.origin + '/auth/publickey'\n    },\n    panel: {\n      enable: false\n    },\n    daemon: {\n      auth: {\n        url: location.origin + '/oauth2/token',\n        ...deploymentData\n      },\n      data: {\n        root: '/var/lib/pufferpanel'\n      },\n      sftp: {\n        host: `0.0.0.0:${sftpPort.value}`\n      }\n    }\n  }\n  return JSON.stringify(config, undefined, 2)\n}\n\nfunction closeDeploy() {\n  deploymentOpen.value = false\n  currentStep.value = 1\n  fetchFeatures()\n}\n</script>\n\n<template>\n  <div class=\"nodeview\">\n    <h1 v-text=\"name\" />\n    <loader v-if=\"featuresFetched === null\" />\n    <div v-else-if=\"featuresFetched === false\" class=\"features\">\n      <div class=\"unreachable\" v-text=\"t('nodes.Unreachable')\" />\n    </div>\n    <div v-else class=\"features\">\n      <div class=\"reachable\" v-text=\"t('nodes.Reachable')\" />\n      <div class=\"os\">\n        <span v-text=\"t('nodes.features.os.label')\" />\n        <span v-text=\"t('nodes.features.os.' + features.os)\" />\n      </div>\n      <div class=\"arch\">\n        <span v-text=\"t('nodes.features.arch.label')\" />\n        <span v-text=\"t('nodes.features.arch.' + features.arch)\" />\n      </div>\n      <div class=\"env\">\n        <span v-text=\"t('nodes.features.envs')\" />\n        <span v-text=\"features.envs.join(', ')\" />\n      </div>\n      <div class=\"docker\">\n        <span v-text=\"t('env.docker.name')\" />\n        <span v-text=\"t('nodes.features.docker.' + features.docker)\" />\n      </div>\n    </div>\n    <h2 v-text=\"t('nodes.Edit')\" />\n    <div v-if=\"route.params.id > 0\" class=\"edit\">\n      <text-field v-model=\"name\" class=\"name\" :label=\"t('common.Name')\" />\n      <text-field v-model=\"publicHost\" class=\"public-host\" :label=\"t('nodes.PublicHost')\" />\n      <text-field v-model=\"publicPort\" class=\"public-port\" :label=\"t('nodes.PublicPort')\" type=\"number\" />\n      <toggle v-model=\"withPrivateHost\" class=\"private-toggle\" :label=\"t('nodes.WithPrivateAddress')\" :hint=\"t('nodes.WithPrivateAddressHint')\" />\n      <text-field v-if=\"withPrivateHost\" v-model=\"privateHost\" class=\"private-host\" :label=\"t('nodes.PrivateHost')\" />\n      <text-field v-if=\"withPrivateHost\" v-model=\"privatePort\" class=\"private-port\" :label=\"t('nodes.PrivatePort')\" type=\"number\" />\n      <text-field v-model=\"sftpPort\" class=\"sftp-port\" :label=\"t('nodes.SftpPort')\" type=\"number\" />\n      <btn :disabled=\"!canSubmit()\" color=\"primary\" @click=\"submit()\"><icon name=\"save\" />{{ t('nodes.Update') }}</btn>\n      <btn color=\"error\" @click=\"deleteNode()\"><icon name=\"remove\" />{{ t('nodes.Delete') }}</btn>\n      <btn @click=\"deploymentOpen = true\" v-text=\"t('nodes.Deploy')\" />\n    </div>\n    <!-- eslint-disable-next-line vue/no-v-html -->\n    <div v-else class=\"edit\" v-html=\"markdown(t('nodes.LocalNodeEdit'))\" />\n    <overlay v-model=\"deploymentOpen\" closable :title=\"t('nodes.Deploy')\" @close=\"closeDeploy()\">\n      <!-- eslint-disable-next-line vue/no-v-html -->\n      <div v-html=\"markdown(t(`nodes.deploy.Step${currentStep}`, { config: getDeployConfig() }))\" />\n      <btn v-if=\"currentStep < 5\" @click=\"currentStep += 1\" v-text=\"t('common.Next')\" />\n      <btn v-else @click=\"closeDeploy()\" v-text=\"t('common.Close')\" />\n    </overlay>\n  </div>\n</template>\n"],"names":[],"mappings":"wiCAYA,KAAM,GAAM,EAAO,OACb,EAAQ,EAAO,SACf,EAAS,EAAO,UAChB,CAAE,GAAM,IACR,EAAQ,IACR,EAAS,IAET,EAAiB,EAAI,IAC3B,GAAI,GAAiB,GACrB,KAAM,GAAkB,EAAI,IACtB,EAAO,EAAI,IACX,EAAa,EAAI,IACjB,EAAa,EAAI,QACjB,EAAc,EAAI,IAClB,EAAc,EAAI,QAClB,EAAW,EAAI,QACf,EAAc,EAAI,GAClB,EAAkB,EAAI,MACtB,EAAW,EAAI,IAErB,EAAU,SAAY,CACpB,KAAM,GAAO,KAAM,GAAI,KAAK,IAAI,EAAM,OAAO,IAC7C,EAAK,MAAQ,EAAK,KAClB,EAAW,MAAQ,EAAK,WACxB,EAAW,MAAQ,EAAK,WACxB,EAAY,MAAQ,EAAK,YACzB,EAAY,MAAQ,EAAK,YACzB,EAAS,MAAQ,EAAK,SACtB,EAAgB,MAAQ,CAAE,GAAK,aAAe,EAAK,aAAe,EAAK,aAAe,EAAK,aAC3F,EAAiB,KAAM,GAAI,KAAK,WAAW,EAAM,OAAO,IACpD,EAAM,MAAM,SACd,GAAe,MAAQ,IAGzB,MAGF,kBAA+B,CAC7B,EAAgB,MAAQ,KACxB,EAAS,MAAQ,GACjB,GAAI,CACF,KAAM,GAAI,KAAM,GAAI,KAAK,SAAS,EAAM,OAAO,IAC/C,EAAS,MAAM,KAAO,CAAE,GAAG,GAAI,KAAI,EAAE,aAAa,IAAI,GAAK,IAAM,YAAc,IAAM,MAAQ,OAAS,KAAM,IAAI,GAAK,EAAE,OAAO,WAC9H,EAAS,MAAM,OAAS,EAAE,SAAS,QAAQ,YAAc,GACzD,EAAS,MAAM,GAAK,EAAE,GACtB,EAAS,MAAM,KAAO,EAAE,KACxB,EAAgB,MAAQ,QACxB,CACA,EAAgB,MAAQ,IAI5B,YAAqB,CAKnB,MAJI,GAAC,EAAK,OACN,CAAC,EAAW,OACZ,CAAC,EAAW,OACZ,CAAC,EAAS,OACV,EAAgB,OACd,EAAC,EAAY,OACb,CAAC,EAAY,QAKrB,kBAAwB,CACtB,GAAI,CAAC,IAAa,OAClB,KAAM,GAAO,CACX,KAAM,EAAK,MACX,WAAY,EAAW,MACvB,WAAY,EAAW,MACvB,SAAU,EAAS,OAErB,AAAI,EAAgB,MAClB,GAAK,YAAc,EAAY,MAC/B,EAAK,YAAc,EAAY,OAE/B,GAAK,YAAc,EAAW,MAC9B,EAAK,YAAc,EAAW,OAEhC,KAAM,GAAI,KAAK,OAAO,EAAM,OAAO,GAAI,GACvC,EAAM,QAAQ,EAAE,kBAGlB,kBAA4B,CAC1B,EAAO,KACL,UACA,EAAE,sBAAuB,CAAE,KAAM,EAAK,QACtC,CACE,KAAM,EAAE,gBACR,KAAM,SACN,MAAO,QACP,OAAQ,SAAY,CAClB,KAAM,GAAI,KAAK,OAAO,EAAM,OAAO,IACnC,EAAM,QAAQ,EAAE,kBAChB,EAAO,KAAK,CAAE,KAAM,eAGxB,CACE,MAAO,YAKb,YAA2B,CACzB,KAAM,GAAS,CACb,KAAM,uBACN,IAAK,CACH,KAAM,WAAW,EAAY,SAE/B,MAAO,CACL,OAAQ,SAAS,OAAS,mBAE5B,MAAO,CACL,OAAQ,IAEV,OAAQ,CACN,KAAM,GACJ,IAAK,SAAS,OAAS,iBACpB,GAEL,KAAM,CACJ,KAAM,wBAER,KAAM,CACJ,KAAM,WAAW,EAAS,WAIhC,MAAO,MAAK,UAAU,EAAQ,OAAW,GAG3C,YAAuB,CACrB,EAAe,MAAQ,GACvB,EAAY,MAAQ,EACpB"}